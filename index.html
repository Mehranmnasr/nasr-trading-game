<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>بازی ترید ارز دیجیتال نصر</title>
  <!-- Lightweight Charts -->
  <script src="https://unpkg.com/lightweight-charts@4.1.2/dist/lightweight-charts.standalone.production.js"></script>
  <!-- Chart.js for RSI -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.0/dist/chartjs-plugin-annotation.min.js"></script>
  <style>
    body {
      background-color: #003366;
      color: white;
      font-family: sans-serif;
      direction: rtl;
      text-align: center;
      margin: 20px;
    }
    #timeFrameTabs {
      margin-bottom: 10px;
    }
    .tab {
      padding: 10px 8px;
      margin: 0 5px;
      border: 1px solid #555;
      cursor: pointer;
      display: inline-block;
      background-color: #1e1e1e;
    }
    .tab.active {
      background-color: #007bff;
      color: white;
      border-color: #007bff;
    }
    .timeframe-tab {
      padding: 5px 4px; /* تغییر کرد */
      margin: 0 2.5px; /* تغییر کرد */
      border: 1px solid #555;
      cursor: pointer;
      display: inline-block;
      background-color: #1e1e1e;
      font-size: 14px; /* اضافه شد */
    }
    .timeframe-tab.active { /* اضافه شد */
      background-color: #007bff;
      color: white;
      border-color: #007bff;
    }
    .coin-tab {
      padding: 6px 8px;
      margin: 2px 3px;
      font-size: 12px;
      background-color: #1e1e1e;
      border: 1px solid #555;
      display: inline-block;
      width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .coin-tab.active {
      background-color: #0056b3;
      border-color: #0056b3;
    }
    #chartContainer {
      width: 100%;
      max-width: 400px;
      background-color: #0d1b2a;
      aspect-ratio: 1;
      margin: auto;
      border-radius: 8px;
      overflow: hidden;
    }
    #rsiChartContainer {
      width: 300px;
      height: 150px;
      background-color: white;
      margin: 20px auto;
      border-radius: 6px;
    }
    .btn {
      padding: 10px 20px;
      margin: 5px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
    }
    .upgrade-btn {
      padding: 8px 12px; /* کمی کوچکتر */
      margin: 2px 1px; /* کمی کوچکتر */
      font-size: 14px; /* کمی کوچکتر */
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background-color: #007bff; /* رنگ آبی */
      color: white;
    }
    .upgrade-btn:disabled {
      background-color: #6c757d; /* رنگ خاکستری وقتی غیرفعال */
      cursor: not-allowed;
    }
    .info {
      margin-top: 10px;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    select, input {
      padding: 6px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #555;
      background-color: #1e1e1e;
      color: white;
    }
    #freezePriceBtn {
      margin-top: 10px;
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      display: block;
      margin: 10px auto 0;
    }
    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }
    /* استایل جدید برای کارت کیف پول */
    #walletCard {
      display: none;
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      color: black;
      padding: 20px;
      border-radius: 8px;
      width: 320px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      z-index: 1000;
      cursor: pointer;
    }
    #walletCard ul {
      text-align: right;
      max-height: 200px;
      overflow-y: auto;
      padding-right: 20px;
    }
    #walletCard li {
      list-style: none;
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
    #walletCard li:last-child {
      border-bottom: none;
    }
    #walletTab {
      background-color: #28a745; /* رنگ سبز */
    }
    #walletTab.active {
      background-color: #218838; /* رنگ سبز تیره‌تر */
    }
    /* استایل جدید برای کارت ارتقاء */
    #upgradeCard {
      display: none;
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      color: black;
      padding: 20px;
      border-radius: 8px;
      width: 320px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      z-index: 1000;
      cursor: pointer;
    }
    #upgradeCard .upgrade-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    #upgradeCard .upgrade-item:last-child {
      border-bottom: none;
    }
    #upgradeTab {
      background-color: #6f42c1; /* رنگ بنفش */
    }
    #upgradeTab.active {
      background-color: #5a32a3; /* رنگ بنفش تیره‌تر */
    }
    .upgrade-tab-inactive {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>بازی ترید ارز دیجیتال نصر</h1>
  <div id="timeFrameTabs">
    <span class="tab" id="infoTab">❕</span>
    <div id="infoCard" style="display: none;
        position: fixed;
        top: 70px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        color: black;
        padding: 20px;
        border-radius: 8px;
        width: 300px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        cursor: pointer;
        z-index: 1000;">
      <h3>اطلاعات ارز</h3>
      <p>اسم ارز: <span id="coinNameDisplay">بیتکوین</span></p>
      <p>مارکت کپ: <span id="marketCap">336.0B</span></p>
      <p>تعداد عرضه کل: <span id="totalSupplyDisplay">21.00M</span></p>
      <!-- اضافه شده: نمایش دامیننس بیتکوین -->
      <p id="dominanceDisplay" style="display: none;">دامیننس بیتکوین: <span id="bitcoinDominanceValue">40%</span></p>
      <!-- پایان اضافه شده -->
      <p>میزان سکه های ارز بصورت درصد: <span id="percentRemaining">100%</span></p>
      <p>میزان سکه های خریده شده ارز بصورت درصد: <span id="percentBought">0%</span></p>
      <hr style="margin: 10px 0;">
      <h4>صندوق نقدینگی</h4>
      <p>موجودی صندوق: $<span id="liquidityPoolValue">100000</span></p>
      <div style="margin-top: 8px;">
        <button class="btn" onclick="depositToPool(100000)" style="background-color:#28a745; font-size:12px; padding:4px 8px; margin:2px;">+ 100K</button>
        <button class="btn" onclick="depositToPool(1000000)" style="background-color:#28a745; font-size:12px; padding:4px 8px; margin:2px;">+ 1M</button>
        <button class="btn" onclick="depositToPool(10000000)" style="background-color:#28a745; font-size:12px; padding:4px 8px; margin:2px;">+ 10M</button>
      </div>
      <div style="margin-top: 6px;">
        <button class="btn" onclick="withdrawFromPool(100000)" style="background-color:#dc3545; font-size:12px; padding:4px 8px; margin:2px;">- 100K</button>
        <button class="btn" onclick="withdrawFromPool(1000000)" style="background-color:#dc3545; font-size:12px; padding:4px 8px; margin:2px;">- 1M</button>
        <button class="btn" onclick="withdrawFromPool(10000000)" style="background-color:#dc3545; font-size:12px; padding:4px 8px; margin:2px;">- 10M</button>
      </div>
      <small>برای بستن برگه، روی اینجا کلیک کن</small>
    </div>
    <div id="secretForm" style="display: none; margin-top: 20px;">
      <input type="text" id="secretCode" placeholder="کد مخفی را وارد کنید" />
      <input type="number" id="secretAmount" placeholder="مقدار دلار" />
      <button id="applySecret">تأیید</button>
    </div>
    <span class="tab" id="secretTab">➕</span>
    <span class="tab" id="myCoinTab">🪙</span>
    <div id="myCoinForm" style="display: none;
        position: fixed;
        top: 70px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        color: black;
        padding: 20px;
        border-radius: 8px;
        width: 320px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        z-index: 1000;">
      <h3>ساخت ارز دیجیتال شخصی</h3>
      <p>هزینه ساخت: <strong>100 دلار</strong></p>
      <input type="text" id="coinNameInput" placeholder="نام ارز (مثلاً نصر‌کوین)" style="width: 100%; margin: 8px 0; padding: 6px;">
      <input type="number" id="totalSupplyInput" placeholder="تعداد کل سکه‌ها (مثلاً 1000000)" min="1000" style="width: 100%; margin: 8px 0; padding: 6px;">
      <input type="number" id="listingPriceInput" placeholder="قیمت لیست شدن (دلار)" min="0.01" step="0.01" style="width: 100%; margin: 8px 0; padding: 6px;">
      <!-- قسمت جدید: انتخاب شبکه -->
      <label for="networkSelect">شبکه ارز:</label>
      <select id="networkSelect" style="width: 100%; margin: 8px 0; padding: 6px;">
        <option value="native">بومی</option>
        <option value="bitcoin">بیتکوین</option>
        <option value="ethereum">اتریوم</option>
        <option value="binance">بایننس کوین</option>
      </select>
      <!-- پایان قسمت جدید -->
      <div style="margin-top: 10px;">
        <button id="createCoinBtn" class="btn" style="background-color: #28a745; color: white; width: 100%;">ساخت ارز 🚀</button>
      </div>
      <small style="display: block; margin-top: 10px; cursor: pointer;" id="closeMyCoinForm">لغو</small>
    </div>
    <!-- تب پروفایل -->
    <span class="tab" id="profileTab">🧑🏻‍✈️</span>
    <!-- کارت پروفایل -->
    <div id="profileCard" style="display: none;
        position: fixed;
        top: 70px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        color: black;
        padding: 20px;
        border-radius: 8px;
        width: 300px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        cursor: pointer;
        z-index: 1000;">
      <h3>پروفایل معامله‌گر</h3>
      <p>نام: <strong id="traderName">پلیر</strong></p>
      <p>سرمایه اولیه: $1,000</p>
      <p>موجودی فعلی: $<span id="currentBalanceProfile">1000</span></p>
      <p>سود/زیان کل: <span id="totalPnLPercent">0.00%</span></p>
      <!-- بخش جدید برای سطح کاربری -->
      <p>سطح کاربری: <span id="userLevel">تازه کار</span> <span id="userStars">⭐</span></p>
      <!-- پایان بخش جدید -->
      <small>برای بستن، کلیک کنید</small>
    </div>
    <!-- تب کیف پول -->
    <span class="tab" id="walletTab">💼</span>
    <!-- کارت کیف پول -->
    <div id="walletCard" style="display: none;
        position: fixed;
        top: 70px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        color: black;
        padding: 20px;
        border-radius: 8px;
        width: 320px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        z-index: 1000;
        cursor: pointer;">
      <h3>کیف پول من</h3>
      <ul id="walletList">
        <!-- محتوای کیف پول اینجا نمایش داده می‌شود -->
      </ul>
      <small>برای بستن، کلیک کنید</small>
    </div>
    <!-- تب ارتقاء (Diamond) -->
    <span class="tab" id="upgradeTab">💎</span>
    <!-- کارت ارتقاء -->
    <div id="upgradeCard" style="display: none;
        position: fixed;
        top: 70px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        color: black;
        padding: 20px;
        border-radius: 8px;
        width: 320px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        z-index: 1000;
        cursor: pointer;">
      <h3>ارتقای ارز دیجیتال</h3>
      <div class="upgrade-item">
        <span>افزایش سرعت تراکنش (TPS)</span>
        <button class="upgrade-btn" id="upgradeTpsBtn">خرید</button>
      </div>
      <div class="upgrade-item">
        <span>بهبود امنیت (RSA512 -> SHA256)</span>
        <button class="upgrade-btn" id="upgradeSecurityBtn">خرید</button>
      </div>
      <div class="upgrade-item">
        <span>تغییر الگوریتم اجماع (PoW -> PoS)</span>
        <button class="upgrade-btn" id="upgradeConsensusBtn">خرید</button>
      </div>
      <div class="upgrade-item">
        <span>قابلیت استفاده در NFT</span>
        <button class="upgrade-btn" id="upgradeNftBtn">خرید</button>
      </div>
      <div class="upgrade-item">
        <span>مارکتینگ و برندینگ</span>
        <button class="upgrade-btn" id="upgradeMarketingBtn">خرید</button>
      </div>
      <small>برای بستن، کلیک کنید</small>
    </div>
  </div>
  <span class="timeframe-tab active" data-frame="live">30 دقیقه</span>
  <span class="timeframe-tab" data-frame="hour1">1 ساعته</span>
  <span class="timeframe-tab" data-frame="hour4">4 ساعته</span>
  <span class="timeframe-tab" data-frame="day1">روزانه</span>
  <span class="timeframe-tab" data-frame="week1">هفتگی</span> <!-- اضافه شد -->
  <span class="tab coin-tab" id="coinNameTab">بیتکوین</span>
  <span class="tab coin-tab" id="coinEthereumTab">اتریوم</span> <!-- اضافه شد -->
  <span class="tab coin-tab" id="coinBinanceTab">بایننس کوین</span> <!-- اضافه شد -->
  <span class="tab coin-tab" id="personalCoinTab" style="display: none;"></span>
  <div id="calendarContainer" style="margin-top: 20px; background: white; color: black; padding: 1px; border-radius: 6px; width: 100px; font-size: 13px; margin: auto;">
    <p>تاریخ فعلی: <span id="virtualDayDisplay">1/1/2022</span></p>
  </div>
  <button id="freezePriceBtn" title="فریز قیمت (جلوگیری از پامپ/دامپ)">⏸️</button>
  <div id="chartContainer">
    <div id="priceChart" style="width: 100%; height: 100%;"></div>
  </div>
  <div id="rsiChartContainer">
    <canvas id="rsiChart"></canvas>
  </div>
  <div id="controlPanel">
    <div class="info">
      <span>موجودی: <span id="balance">1000</span> دلار</span>
    </div>
    <div class="info">
      <span>قیمت فعلی ارز: $<span id="currentPrice">16000</span> (<span id="priceChange24h">+0.00%</span>)</span>
    </div>
    <div class="info">
      <span>حد ضرر فعال: $<span id="stopLossDisplay">—</span></span>
    </div>
    <div>
      <button class="btn" id="buyBtn" style="background-color: #28a745;">خرید 🟢</button>
      <button class="btn" id="sellBtn" style="background-color: #dc3545;">فروش 🔴</button>
    </div>
    <div class="info">
      <label for="tradePercent">٪ مقدار خرید/فروش:</label>
      <select id="tradePercent">
        <option value="10">10%</option>
        <option value="30">30%</option>
        <option value="50">50%</option>
        <option value="100">100%</option>
      </select>
    </div>
    <div class="info">
      <label for="orderType">نوع اوردر:</label>
      <select id="orderType">
        <option value="market">مارکت</option>
        <option value="limit">لیمیت</option>
      </select>
    </div>
    <div class="info" id="limitPriceInput" style="display: none;">
      <label for="limitPrice">قیمت دلخواه:</label>
      <input type="number" id="limitPrice" placeholder="قیمت دلخواه خرید/فروش" min="0" step="any" />
    </div>
    <div class="info">
      <label for="stopLossPercent">٪ حد ضرر:</label>
      <select id="stopLossPercent">
        <option value="5">5٪</option>
        <option value="10">10٪</option>
        <option value="15">15٪</option>
      </select>
    </div>
    <div class="info">
      <p>تعداد ارز خریداری‌شده: <span id="coinAmount">0</span> عدد</p>
      <p>میانگین قیمت خریداری‌شده: $<span id="avgPrice">0</span></p>
      <p>ارزش دارایی‌های خریداری شده: $<span id="assetValue">0</span></p>
      <p>سود/ضرر کل: $<span id="profitLoss">0</span></p>
    </div>
    <div class="info" style="margin-top: 10px;">
      <button id="transferToWalletBtn" class="btn" style="background-color: #ffc107; color: black;">انتقال به کیف پول</button>
      <button id="transferFromWalletBtn" class="btn" style="background-color: #6f42c1; color: white;">انتقال از کیف پول</button>
    </div>
    <div class="info" style="margin-top: 10px;">
      <button id="resetBtn" class="btn" style="background-color: #ff4d4d; color: white;">ریست بازی 🔄</button>
      <button id="burnBalanceBtn" class="btn" style="background-color: #ff6600; color: white; margin-right: 10px;">سوزاندن دلار 🔥</button>
    </div>
  </div>
  <script>
    // ========== تابع کمکی RSI ==========
    function calculateRSI(data, period) {
      let rsi = [];
      for (let i = 0; i < data.length; i++) {
        if (i < period) {
          rsi.push(null);
          continue;
        }
        let gains = 0, losses = 0;
        for (let j = i - period + 1; j <= i; j++) {
          let diff = data[j] - data[j - 1];
          if (diff >= 0) gains += diff;
          else losses -= diff;
        }
        let avgGain = gains / period;
        let avgLoss = losses / period;
        let rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
        rsi.push((100 - (100 / (1 + rs))).toFixed(2));
      }
      return rsi;
    }
    // ========== تابع کمکی SMA ==========
    function calculateSMA(data, period) {
      let sma = [];
      for (let i = 0; i < data.length; i++) {
        if (i < period - 1) {
          sma.push(null);
          continue;
        }
        let sum = 0;
        for (let j = i - period + 1; j <= i; j++) {
          sum += data[j];
        }
        sma.push(sum / period);
      }
      return sma;
    }
    // ========== متغیرهای ثابت ==========
    const rsiPeriod = 14;
    const smaPeriod = 50;
    const globalMaxHistory = 250; // تغییر کرد
    // ========== تابع ساخت داده اولیه ==========
    function createInitialTimeframeData(price) {
      return {
        labels: [1],
        priceData: [price],
        barData: [0],
        rsiData: calculateRSI([price], rsiPeriod),
        smaData: calculateSMA([price], smaPeriod) // اضافه شد
      };
    }
    // ========== متغیرهای سراسری ==========
    let virtualDay = 1;
    let virtualMonth = 1;
    let virtualYear = 2022;
    let moveCounter = 0;
    let balance = 1000;
    let isPriceFrozen = false;
    // ========== متغیرهای جدید ==========
    let traderName = "پلیر";
    let initialBalance = 1000;
    let liquidityPool = 100000; // صندوق نقدینگی پیش‌فرض
    const volatilityUp = 0.03;
    const volatilityDown = 0.029;
    const cycleLength = 2;
    // --- متغیرهای جدید برای دامیننس و همبستگی ---
    let currentBitcoinDominance = 40; // شروع با 40%
    let lastUpdatedMonth = virtualMonth; // ذخیره آخرین ماه بروزرسانی
    const minDominance = 40;
    const maxDominance = 70;
    const minCorrelation = 0.30; // 30% همبستگی وقتی دامیننس 40% است
    const maxCorrelation = 0.80; // 80% همبستگی وقتی دامیننس 70% است
    // --- پایان متغیرهای جدید ---
    const timeFrameConfigs = {
      live: { maxPoints: 30, interval: 2000, timeframe: 'live' },
      hour1: { maxPoints: 50, interval: 3000, timeframe: 'hour1' }, // تغییر کرد
      hour4: { maxPoints: 100, interval: 4000, timeframe: 'hour4' }, // تغییر کرد
      day1: { maxPoints: 150, interval: 5000, timeframe: 'day1' }, // تغییر کرد
      week1: { maxPoints: 200, interval: 6000, timeframe: 'week1' } // اضافه شد
    };
    let currentConfig = timeFrameConfigs.live;
    let currentIntervalId = null;
    // ========== ساختار مدیریت چند ارز با تایم‌فریم‌های مستقل ==========
    let coins = {
      bitcoin: {
        name: "بیتکوین",
        totalSupply: 21000000,
        livePrice: 16000, // تغییر کرد
        coinAmount: 0,
        avgPrice: 0,
        stopLossPrice: 0,
        price24hAgo: 16000, // اضافه شد - مقدار اولیه قیمت فعلی
        cycleStep: 0,
        timeframes: {
          live: createInitialTimeframeData(16000), // تغییر کرد
          hour1: createInitialTimeframeData(16000), // تغییر کرد
          hour4: createInitialTimeframeData(16000), // تغییر کرد
          day1: createInitialTimeframeData(16000), // تغییر کرد
          week1: createInitialTimeframeData(16000) // تغییر کرد
        }
      },
      // اضافه کردن اتریوم و بایننس کوین با قیمت‌های جدید و price24hAgo
      ethereum: {
        name: "اتریوم",
        totalSupply: 120000000, // 120M
        livePrice: 1100, // تغییر کرد
        coinAmount: 0,
        avgPrice: 0,
        stopLossPrice: 0,
        price24hAgo: 1100, // اضافه شد - مقدار اولیه قیمت فعلی
        cycleStep: 0,
        timeframes: {
          live: createInitialTimeframeData(1100), // تغییر کرد
          hour1: createInitialTimeframeData(1100), // تغییر کرد
          hour4: createInitialTimeframeData(1100), // تغییر کرد
          day1: createInitialTimeframeData(1100), // تغییر کرد
          week1: createInitialTimeframeData(1100) // تغییر کرد
        }
      },
      binance: {
        name: "بایننس کوین",
        totalSupply: 140000000, // 140M
        livePrice: 200, // تغییر کرد
        coinAmount: 0,
        avgPrice: 0,
        stopLossPrice: 0,
        price24hAgo: 200, // اضافه شد - مقدار اولیه قیمت فعلی
        cycleStep: 0,
        timeframes: {
          live: createInitialTimeframeData(200), // تغییر کرد
          hour1: createInitialTimeframeData(200), // تغییر کرد
          hour4: createInitialTimeframeData(200), // تغییر کرد
          day1: createInitialTimeframeData(200), // تغییر کرد
          week1: createInitialTimeframeData(200) // تغییر کرد
        }
      }
    };
    let currentCoin = 'bitcoin';
    let personalCoinKey = null;
    // ========== اوردرهای لیمیت ==========
    let limitOrders = [];
    // ========== کیف پول جدید ==========
    let wallet = {}; // یک شیء خالی برای نگهداری ارزهای کیف پول
    // ========== متغیرهای جدید برای همبستگی (اکنون پویا) ==========
    // const correlationFactor = 0.8; // 80% همبستگی - این دیگر ثابت نیست
    const independentFactor = 1 - maxCorrelation; // حداکثر مستقل (20% وقتی همبستگی 80% است)
    const independentVolatility = 0.01; // 1% نوسان مستقل
    // ========== Lightweight Charts ==========
    let priceChart = null;
    let candlestickSeries = null;
    let smaSeries = null; // اضافه شد
    function initPriceChart() {
      const container = document.getElementById('priceChart');
      priceChart = LightweightCharts.createChart(container, {
        layout: {
          backgroundColor: '#0d1b2a',
          textColor: 'white',
        },
        grid: {
          vertLines: { color: '#1e3a5f' },
          horzLines: { color: '#1e3a5f' },
        },
        crosshair: {
          mode: LightweightCharts.CrosshairMode.Normal,
        },
        rightPriceScale: {
          borderColor: '#444',
          scaleMargins: { top: 0.1, bottom: 0.2 },
          textColor: '#666666',
        },
        timeScale: {
          borderColor: '#444',
          timeVisible: true,
          secondsVisible: false,
          textColor: '#666666',
        },
        handleScroll: {
          mouseWheel: true,
          pressedMouseMove: true,
        },
        handleScale: {
          axisPressedMouseMove: true,
          mouseWheel: true,
          pinch: true,
        },
      });
      candlestickSeries = priceChart.addCandlestickSeries({
        upColor: '#26a69a',
        downColor: '#ef5350',
        borderVisible: false,
        wickUpColor: '#26a69a',
        wickDownColor: '#ef5350',
      });
      // اضافه کردن خط SMA
      smaSeries = priceChart.addLineSeries({
        color: '#FF9800', // رنگ نارنجی
        lineWidth: 1
        // title: 'SMA 50' این خط حذف شد
      });
    }
    function updatePriceChart() {
      const coin = getCurrentCoinData();
      const tfData = coin.timeframes[currentConfig.timeframe];
      const data = tfData.priceData.map((price, i) => {
        const time = Math.floor(Date.now() / 1000) - (tfData.priceData.length - i) * 60;
        const open = i === 0 ? price : tfData.priceData[i - 1];
        return {
          time: time,
          open: open,
          high: Math.max(price, open),
          low: Math.min(price, open),
          close: price
        };
      });
      const maxPoints = currentConfig.maxPoints || 50;
      candlestickSeries.setData(data.slice(-maxPoints));
      // آپدیت SMA در نمودار
      let smaData = tfData.priceData.map((price, i) => ({
        time: Math.floor(Date.now() / 1000) - (tfData.priceData.length - i) * 60,
        value: tfData.smaData[i]
      }));
      // فقط داده‌هایی که مقدار دارن (مثلاً بعد از 50 تا) رو نمایش بده
      const filteredSmaData = smaData.filter(item => item.value !== null);
      if (filteredSmaData.length > 0) {
        smaSeries.setData(filteredSmaData.slice(-currentConfig.maxPoints));
      } else {
        smaSeries.setData([]);
      }
      if (data.length > 0) {
        priceChart.timeScale().fitContent();
      }
    }
    // ========== توابع کمکی اضافی ==========
    // --- تابع جدید: محاسبه دامیننس بیتکوین بر اساس ماه ---
    function calculateBitcoinDominance(currentMonth) {
      // چرخه 4 ماهه: 40 -> 50 -> 60 -> 70 -> 40 ...
      // ماه ها: 1,2,3,4,5,6,7,8 -> مقدار چرخه: (1-1)%4=0, (2-1)%4=1, (3-1)%4=2, (4-1)%4=3, (5-1)%4=0, ...
      // اندیس چرخه: 0,1,2,3
      const cycleIndex = (currentMonth - 1) % 4;
      let dominance;
      switch(cycleIndex) {
        case 0:
          dominance = 40;
          break;
        case 1:
          dominance = 50;
          break;
        case 2:
          dominance = 60;
          break;
        case 3:
          dominance = 70;
          break;
        default:
          dominance = 40; // پیش‌فرض
      }
      return dominance;
    }
    // --- پایان تابع جدید ---
    // --- تابع جدید: محاسبه همبستگی بر اساس دامیننس ---
    function calculateCorrelationFromDominance(dominance) {
        // استفاده از فرمول خطی بین دو نقطه: (40, 0.30) و (70, 0.80)
        // شیب = (0.80 - 0.30) / (70 - 40) = 0.50 / 30 = 0.016666...
        // y - y1 = m(x - x1) -> y = m(x - x1) + y1
        // y = 0.016666... * (dominance - 40) + 0.30
        const slope = (maxCorrelation - minCorrelation) / (maxDominance - minDominance);
        const calculatedCorrelation = slope * (dominance - minDominance) + minCorrelation;
        // اطمینان از اینکه مقدار در بازه [minCorrelation, maxCorrelation] باشد
        return Math.min(Math.max(calculatedCorrelation, minCorrelation), maxCorrelation);
    }
    // --- پایان تابع جدید ---
    function getCyclicFactor(currentStep, cycleLength) {
      const phase = (currentStep % cycleLength) / cycleLength;
      let factor;
      if (phase < 0.5) {
        factor = 1 + (phase * 1.2) * 0.05 + 0.002 * Math.sin(phase * Math.PI * 1);
      } else {
        const subPhase = (phase - 0.5) * 1.2;
        factor = 1 - (subPhase * 0.049) + 0.002 * Math.sin(subPhase * Math.PI * 1);
      }
      return factor;
    }
    function formatMarketCap(valueInMillions) {
      if (valueInMillions >= 1_000_000) { // اگر مقدار بیشتر یا مساوی 1000000 میلیون بود (یعنی 1 تریلیون دلار)
        return (valueInMillions / 1_000_000).toFixed(1) + "T"; // تقسیم بر 1000000 و نمایش با T
      } else if (valueInMillions >= 1000) { // اگر بین 1000 تا 999999 میلیون بود
        return (valueInMillions / 1000).toFixed(1) + "B"; // تقسیم بر 1000 و نمایش با B
      } else { // اگر کمتر از 1000 میلیون بود
        return valueInMillions.toFixed(1) + "M"; // نمایش با M
      }
    }
    // تابع جدید برای فرمت عرضه کل
    function formatTotalSupply(value) {
      if (value >= 1_000_000_000) {
        return (value / 1_000_000_000).toFixed(2) + "B";
      } else if (value >= 1_000_000) {
        return (value / 1_000_000).toFixed(2) + "M";
      } else {
        return value.toLocaleString(); // برای اعداد کوچکتر، با جداکننده هزار نمایش داده شود
      }
    }
    function getCurrentCoinData() {
      return coins[currentCoin];
    }
    function switchToCoin(coinKey) {
      if (!coins[coinKey]) return;
      currentCoin = coinKey;
      const newCoin = getCurrentCoinData();
      document.getElementById("coinNameDisplay").innerText = newCoin.name;
      // --- بخش جدید: نمایش/عدم نمایش دامیننس در کارت اطلاعات ---
      const dominanceDisplay = document.getElementById("dominanceDisplay");
      if (coinKey === 'bitcoin') {
        dominanceDisplay.style.display = 'block';
        document.getElementById("bitcoinDominanceValue").innerText = currentBitcoinDominance.toFixed(2) + "%";
      } else {
        dominanceDisplay.style.display = 'none';
      }
      // --- پایان بخش جدید ---
      // استفاده از تابع جدید برای فرمت عرضه کل
      document.getElementById("totalSupplyDisplay").innerText = formatTotalSupply(newCoin.totalSupply);
      // --- بخش جدید: آپدیت مارکت کپ در کارت اطلاعات ---
      const marketCapInMillions = (newCoin.livePrice * newCoin.totalSupply) / 1_000_000;
      document.getElementById("marketCap").innerText = formatMarketCap(marketCapInMillions);
      // --- پایان بخش جدید ---
      updateCoinPercentages();
      updateDisplay();
      updatePriceChart();
      const tfData = newCoin.timeframes[currentConfig.timeframe];
      rsiChart.data.labels = tfData.labels.slice(-currentConfig.maxPoints);
      rsiChart.data.datasets[0].data = tfData.rsiData.slice(-currentConfig.maxPoints);
      rsiChart.update();
      // --- بخش اصلاح شده برای مدیریت کلاس 'active' تب‌های ارز ---
      // اول از همه تب‌های ارز، کلاس 'active' رو حذف می‌کنیم
      document.querySelectorAll('.coin-tab').forEach(tab => tab.classList.remove('active'));
      // بعد، تب مربوط به ارز فعلی رو پیدا می‌کنیم و کلاس 'active' اضافه می‌کنیم
      // برای ارزهای پیش‌فرض
      if (coinKey === 'bitcoin') {
        document.getElementById('coinNameTab').classList.add('active');
      } else if (coinKey === 'ethereum') {
        document.getElementById('coinEthereumTab').classList.add('active');
      } else if (coinKey === 'binance') {
        document.getElementById('coinBinanceTab').classList.add('active');
      }
      // برای ارز شخصی
      else if (personalCoinKey && coinKey === personalCoinKey) {
        document.getElementById('personalCoinTab').classList.add('active');
      }
      // --- پایان بخش اصلاح شده ---
      // --- بخش جدید: بروزرسانی وضعیت تب ارتقاء ---
      updateUpgradeTabStatus();
      // --- پایان بخش جدید ---
    }
    function checkLimitOrdersForCoin(coinKey, newPrice) {
      // این تابع الان فقط چک می‌کنه که آیا اوردرهای مربوط به این ارز (coinKey) اجرا می‌شن یا نه
      for (let i = limitOrders.length - 1; i >= 0; i--) {
        const order = limitOrders[i];
        if (order.coinKey !== coinKey) continue; // فقط اوردرهای این ارز
        const coin = coins[coinKey]; // از شیء ارز استفاده می‌کنیم
        if (order.type === 'buy' && newPrice <= order.price) {
          const amountToSpend = order.amount;
          if (balance >= amountToSpend) {
            const coinsBought = amountToSpend / newPrice;
            const onePercentSupply = coin.totalSupply * 0.01;
            balance -= amountToSpend;
            coin.coinAmount += coinsBought;
            coin.avgPrice = coin.coinAmount > 0
              ? ((coin.avgPrice * (coin.coinAmount - coinsBought)) + (newPrice * coinsBought)) / coin.coinAmount
              : newPrice;
            if (!isPriceFrozen && coinsBought >= onePercentSupply) {
              // تأثیر pump/dump روی صندوق و تغییر قیمت اصلی بیت‌کوین
              const newPumpedPrice = newPrice * 1.05;
              applyPriceChangeForCoin(coinKey, newPumpedPrice); // تغییر قیمت ارز خاص
              // تغییر قیمت بیت‌کوین (اصلی) برای تأثیر روی بقیه
              if (coinKey === 'bitcoin') {
                 coins.bitcoin.livePrice = newPumpedPrice;
              }
              alert(`🔥 خرید بزرگ (${(coinsBought / coin.totalSupply * 100).toFixed(2)}%) روی ${coin.name}!`);
            } else {
              // فقط نمایش ارز فعلی را آپدیت می‌کنیم اگر تغییر کرده باشد
              if (coinKey === currentCoin) {
                updateDisplay();
                updateCoinPercentages(); // بروزرسانی درصد بعد از خرید
              }
            }
            limitOrders.splice(i, 1);
            alert(`✅ اوردر خرید لیمیت شما به قیمت $${order.price} برای ${coin.name} اجرا شد.`);
          }
        } else if (order.type === 'sell' && newPrice >= order.price) {
          const coinsToSell = order.amount / newPrice;
          if (coin.coinAmount >= coinsToSell) {
            const onePercentSupply = coin.totalSupply * 0.01;
            balance += order.amount;
            coin.coinAmount -= coinsToSell;
            if (coin.coinAmount <= 0) {
              coin.coinAmount = 0;
              coin.avgPrice = 0;
            }
            if (!isPriceFrozen && coinsToSell >= onePercentSupply) {
              const newDumpedPrice = newPrice * 0.95;
              applyPriceChangeForCoin(coinKey, newDumpedPrice); // تغییر قیمت ارز خاص
              if (coinKey === 'bitcoin') {
                 coins.bitcoin.livePrice = newDumpedPrice;
              }
              alert(`📉 فروش بزرگ (${(coinsToSell / coin.totalSupply * 100).toFixed(2)}%) روی ${coin.name}!`);
            } else {
              if (coinKey === currentCoin) {
                updateDisplay();
                updateCoinPercentages(); // بروزرسانی درصد بعد از فروش
              }
            }
            limitOrders.splice(i, 1);
            alert(`✅ اوردر فروش لیمیت شما به قیمت $${order.price} برای ${coin.name} اجرا شد.`);
          }
        }
      }
    }
    function applyPriceChangeForCoin(coinKey, newPrice) {
      const coin = coins[coinKey]; // از کلید ارز استفاده می‌کنیم
      if (!coin) return; // اگر ارز وجود نداشت، خارج شو
      coin.livePrice = newPrice;
      // فقط آپدیت داده‌های لایو این ارز
      const liveTf = coin.timeframes.live;
      const timeLabel = liveTf.labels.length ? Number(liveTf.labels[liveTf.labels.length - 1]) + 1 : 1;
      liveTf.labels.push(timeLabel);
      liveTf.priceData.push(newPrice);
      liveTf.barData.push(newPrice - (liveTf.priceData.length > 1 ? liveTf.priceData[liveTf.priceData.length - 2] : newPrice));
      liveTf.rsiData = calculateRSI(liveTf.priceData, rsiPeriod);
      liveTf.smaData = calculateSMA(liveTf.priceData, smaPeriod);
      // آپدیت ارزش صندوق بر اساس تغییر قیمت بیت‌کوین (اگر ارز پایه تغییر کنه)
      // توجه: الان این فقط برای بیت‌کوین اعمال می‌شه، چون صندوق اصلی ممکنه فقط به بیت‌کوین وابسته باشه.
      // اگر می‌خوای صندوق به قیمت میانگین ارزهای مختلف وابسته باشه، نیاز به تغییر داره.
      if (coinKey === 'bitcoin' && moveCounter > 0) {
        const prevPrice = liveTf.priceData[liveTf.priceData.length - 2] || coin.livePrice;
        const priceChangeFactor = newPrice / prevPrice;
        liquidityPool = liquidityPool * priceChangeFactor;
      }
      // آپدیت تایم‌فریم‌های بالاتر فقط برای این ارز
      updateHigherTimeframesForCoin(coinKey, newPrice);
      // محدود کردن حافظه فقط برای این ارز
      for (let tf of ['live', 'hour1', 'hour4', 'day1', 'week1']) {
        const data = coin.timeframes[tf];
        if (data.labels.length > globalMaxHistory) {
          data.labels.shift(); data.priceData.shift(); data.barData.shift(); data.rsiData.shift(); data.smaData.shift();
        }
      }
      // چک کردن اوردرهای لیمیت فقط برای این ارز
      checkLimitOrdersForCoin(coinKey, newPrice);
      // چک کردن حد ضرر فقط برای ارزهایی که در صرافی (coins) هستند
      // فقط اگر ارز فعلی بود، حد ضرر چک شود
      if (coinKey === currentCoin && coin.coinAmount > 0 && newPrice <= coin.stopLossPrice) {
        let coinsToSell = coin.coinAmount;
        balance += coinsToSell * newPrice;
        coin.coinAmount = 0;
        coin.avgPrice = 0;
        updateDisplay();
        updateCoinPercentages(); // بروزرسانی درصد بعد از فروش توسط حد ضرر
        alert(`حد ضرر فعال شد. فروش ${coinsToSell.toFixed(4)} سهم ${coin.name} به قیمت $${newPrice.toFixed(2)} انجام شد.`);
      }
      // فقط نمایش ارز فعلی را آپدیت می‌کنیم
      if (coinKey === currentCoin) {
        updateDisplay();
      }
    }
    function updateHigherTimeframesForCoin(coinKey, newLivePrice) {
      const coin = coins[coinKey]; // از کلید ارز استفاده می‌کنیم
      // --- 1 ساعته: هر 2 حرکت ---
      if (moveCounter % 2 === 0) {
        const tf1h = coin.timeframes.hour1;
        let timeLabel1h = tf1h.labels.length ? tf1h.labels[tf1h.labels.length - 1] + 1 : 1;
        tf1h.labels.push(timeLabel1h);
        tf1h.priceData.push(newLivePrice);
        tf1h.barData.push(newLivePrice - (tf1h.priceData.length > 1 ? tf1h.priceData[tf1h.priceData.length - 2] : newLivePrice));
        tf1h.rsiData = calculateRSI(tf1h.priceData, rsiPeriod);
        tf1h.smaData = calculateSMA(tf1h.priceData, smaPeriod); // اضافه شد
      }
      // --- 4 ساعته: هر 4 حرکت ---
      if (moveCounter % 4 === 0) {
        const tf4h = coin.timeframes.hour4;
        let timeLabel4h = tf4h.labels.length ? tf4h.labels[tf4h.labels.length - 1] + 1 : 1;
        tf4h.labels.push(timeLabel4h);
        tf4h.priceData.push(newLivePrice);
        tf4h.barData.push(newLivePrice - (tf4h.priceData.length > 1 ? tf4h.priceData[tf4h.priceData.length - 2] : newLivePrice));
        tf4h.rsiData = calculateRSI(tf4h.priceData, rsiPeriod);
        tf4h.smaData = calculateSMA(tf4h.priceData, smaPeriod); // اضافه شد
      }
      // --- روزانه: هر 5 حرکت ---
      if (moveCounter % 5 === 0) {
        const tf1d = coin.timeframes.day1;
        let timeLabel1d = tf1d.labels.length ? tf1d.labels[tf1d.labels.length - 1] + 1 : 1;
        tf1d.labels.push(timeLabel1d);
        tf1d.priceData.push(newLivePrice);
        tf1d.barData.push(newLivePrice - (tf1d.priceData.length > 1 ? tf1d.priceData[tf1d.priceData.length - 2] : newLivePrice));
        tf1d.rsiData = calculateRSI(tf1d.priceData, rsiPeriod);
        tf1d.smaData = calculateSMA(tf1d.priceData, smaPeriod); // اضافه شد
      }
      // --- هفتگی: هر 6 حرکت ---
      if (moveCounter % 6 === 0) { // اضافه شد
        const tf1w = coin.timeframes.week1;
        let timeLabel1w = tf1w.labels.length ? tf1w.labels[tf1w.labels.length - 1] + 1 : 1;
        tf1w.labels.push(timeLabel1w);
        tf1w.priceData.push(newLivePrice);
        tf1w.barData.push(newLivePrice - (tf1w.priceData.length > 1 ? tf1w.priceData[tf1w.priceData.length - 2] : newLivePrice));
        tf1w.rsiData = calculateRSI(tf1w.priceData, rsiPeriod);
        tf1w.smaData = calculateSMA(tf1w.priceData, smaPeriod); // اضافه شد
      }
    }
    // ========== تابع جدید برای محاسبه سطح کاربری ==========
    function getUserLevel(pnlPercent) {
      let level = "تازه کار";
      let stars = "⭐";
      if (pnlPercent > 200) {
        level = "جادوگر";
        stars = "⭐⭐⭐⭐⭐";
      } else if (pnlPercent > 100) {
        level = "حرفه ای";
        stars = "⭐⭐⭐⭐";
      } else if (pnlPercent > 50) {
        level = "پیشرفته";
        stars = "⭐⭐⭐";
      } else if (pnlPercent > 20) {
        level = "متوسط";
        stars = "⭐⭐";
      }
      // اگر سود کمتر از 20% بود، پیش‌فرض "تازه کار ⭐" باقی می‌مونه
      return { level, stars };
    }
    function updateDisplay() {
      const coin = getCurrentCoinData();
      document.getElementById("balance").innerText = balance.toFixed(2);
      document.getElementById("currentPrice").innerText = coin.livePrice.toFixed(2);
      // --- تغییر: استفاده از price24hAgo مربوط به ارز فعلی ---
      const change24h = ((coin.livePrice - coin.price24hAgo) / coin.price24hAgo) * 100;
      // --- پایان تغییر ---
      const change24hElement = document.getElementById("priceChange24h");
      change24hElement.innerText = (change24h >= 0 ? '+' : '') + change24h.toFixed(2) + '%';
      change24hElement.style.color = change24h >= 0 ? 'lightgreen' : 'tomato';
      document.getElementById("coinAmount").innerText = coin.coinAmount.toFixed(4);
      document.getElementById("avgPrice").innerText = coin.avgPrice.toFixed(2);
      const assetValue = coin.coinAmount * coin.livePrice;
      document.getElementById("assetValue").innerText = assetValue.toFixed(2);
      const profitLoss = (coin.livePrice - coin.avgPrice) * coin.coinAmount;
      document.getElementById("profitLoss").innerText = profitLoss.toFixed(2);
      document.getElementById("stopLossDisplay").innerText =
        coin.coinAmount > 0 ? coin.stopLossPrice.toFixed(2) : "—";
      // --- بخش اصلاح شده: چک کردن محدودیت خرید با در نظر گرفتن کل سکه‌های خریداری شده (صفاری + کیف پول) ---
      const totalBoughtByUser = coin.coinAmount + (wallet[currentCoin]?.amount || 0);
      document.getElementById("buyBtn").disabled = (balance <= 0 || totalBoughtByUser >= coin.totalSupply);
      // --- پایان بخش اصلاح شده ---
      document.getElementById("sellBtn").disabled = (coin.coinAmount <= 0);
      // آپدیت پروفایل
      document.getElementById("currentBalanceProfile").innerText = balance.toFixed(2);
      const pnlPercent = ((balance - initialBalance) / initialBalance) * 100;
      const pnlElement = document.getElementById("totalPnLPercent");
      pnlElement.innerText = (pnlPercent >= 0 ? '+' : '') + pnlPercent.toFixed(2) + '%';
      pnlElement.style.color = pnlPercent >= 0 ? 'green' : 'red';
      // --- بخش جدید برای سطح کاربری ---
      const userLevelInfo = getUserLevel(pnlPercent);
      document.getElementById("userLevel").innerText = userLevelInfo.level;
      document.getElementById("userStars").innerText = userLevelInfo.stars;
      // --- پایان بخش جدید ---
      // بروزرسانی درصدها در هر بار فراخوانی این تابع
      updateCoinPercentages();
      // --- بخش جدید: بروزرسانی کارت کیف پول ---
      updateWalletDisplay();
      // --- پایان بخش جدید ---
      // --- بخش جدید: بروزرسانی وضعیت دکمه‌های ارتقاء ---
      updateUpgradeButtons();
      // --- پایان بخش جدید ---
    }
    // ========== تابع جدید: اصلاح شده برای محاسبه درصدها با در نظر گرفتن کیف پول ==========
    function updateCoinPercentages() {
      const coin = getCurrentCoinData();
      // --- بخش اصلاح شده: محاسبه مجموع ارز خریداری شده (صفاری + کیف پول) ---
      const totalBoughtAmount = coin.coinAmount + (wallet[currentCoin]?.amount || 0);
      // ---
      // تغییر اصلی: درصد سکه‌های خریداری‌شده توسط کاربر (کل صرافی + کیف پول) نسبت به کل عرضه
      const percentBought = (totalBoughtAmount / coin.totalSupply) * 100;
      const percentRemaining = 100 - percentBought;
      document.getElementById("percentBought").innerText = percentBought.toFixed(4) + "%";
      document.getElementById("percentRemaining").innerText = percentRemaining.toFixed(4) + "%";
      // آپدیت صندوق نقدینگی در کارت اطلاعات
      document.getElementById("liquidityPoolValue").innerText = liquidityPool.toLocaleString();
    }
    function updateCalendarDisplay(day, month, year) {
      document.getElementById("virtualDayDisplay").innerText = `${day}/${month}/${year}`;
    }
    // ========== تابع جدید: ذخیره بازی با اضافه شدن کیف پول ==========
    function saveGame() {
      const data = {
        balance,
        virtualDay,
        virtualMonth,
        virtualYear,
        moveCounter,
        coins, // حالا شامل price24hAgo هر ارز می‌شه
        currentCoin,
        personalCoinKey,
        isPriceFrozen,
        liquidityPool,
        traderName,
        initialBalance,
        limitOrders,
        wallet, // اضافه کردن کیف پول به ذخیره
        // --- ذخیره کردن متغیرهای جدید ---
        currentBitcoinDominance,
        lastUpdatedMonth,
        // --- ذخیره کردن ارتقاهای ارز شخصی ---
        personalCoinUpgrades: coins[personalCoinKey]?.upgrades || [] // ذخیره لیست ارتقاهای خریداری شده
        // --- پایان ذخیره ---
      };
      localStorage.setItem("nasrTradingGameSave", JSON.stringify(data));
    }
    // ========== تابع جدید: بارگذاری بازی با اضافه شدن کیف پول ==========
    function loadGame() {
      const saved = localStorage.getItem("nasrTradingGameSave");
      if (saved) {
        const data = JSON.parse(saved);
        balance = data.balance;
        virtualDay = data.virtualDay || 1;
        virtualMonth = data.virtualMonth || 1;
        virtualYear = data.virtualYear || 2022;
        moveCounter = data.moveCounter || 0;
        coins = data.coins;
        currentCoin = data.currentCoin || 'bitcoin';
        personalCoinKey = data.personalCoinKey || null;
        isPriceFrozen = data.isPriceFrozen || false;
        liquidityPool = data.liquidityPool || 100000;
        traderName = data.traderName || "پلیر";
        initialBalance = data.initialBalance || 1000;
        limitOrders = data.limitOrders || [];
        wallet = data.wallet || {}; // بارگذاری کیف پول
        // --- بارگذاری متغیرهای جدید ---
        currentBitcoinDominance = data.currentBitcoinDominance !== undefined ? data.currentBitcoinDominance : 40;
        lastUpdatedMonth = data.lastUpdatedMonth !== undefined ? data.lastUpdatedMonth : virtualMonth;
        // --- بارگذاری ارتقاهای ارز شخصی ---
        if (personalCoinKey && data.personalCoinUpgrades) {
          if (!coins[personalCoinKey]) {
             coins[personalCoinKey] = {
               upgrades: [] // اگر ارز وجود نداشت (مثلاً بعد از ریست اما قبل از ساخت مجدد)، فقط لیست ارتقاهای ذخیره شده را داشته باش
             };
          }
          coins[personalCoinKey].upgrades = data.personalCoinUpgrades; // بارگذاری لیست ارتقاهای خریداری شده
        }
        // --- پایان بارگذاری ---
        const freezeBtn = document.getElementById('freezePriceBtn');
        freezeBtn.innerText = isPriceFrozen ? '▶️' : '⏸️';
        freezeBtn.title = isPriceFrozen ? 'قیمت فریز شده — پامپ/دامپ غیرفعال' : 'فریز قیمت (جلوگیری از پامپ/دامپ)';
        if (personalCoinKey && coins[personalCoinKey]) {
          document.getElementById("personalCoinTab").innerText = coins[personalCoinKey].name;
          document.getElementById("personalCoinTab").style.display = "inline-block";
        }
        // --- بخش جدید: بروزرسانی کلاس 'active' بر اساس ارز بارگذاری شده و آپدیت مارکت کپ ---
        document.querySelectorAll('.coin-tab').forEach(tab => tab.classList.remove('active'));
        if (currentCoin === 'bitcoin') {
          document.getElementById('coinNameTab').classList.add('active');
          const marketCapInMillions = (coins.bitcoin.livePrice * coins.bitcoin.totalSupply) / 1_000_000;
          document.getElementById("marketCap").innerText = formatMarketCap(marketCapInMillions);
          // --- نمایش دامیننس در کارت اطلاعات بیتکوین بعد از بارگذاری ---
          document.getElementById("dominanceDisplay").style.display = 'block';
          document.getElementById("bitcoinDominanceValue").innerText = currentBitcoinDominance.toFixed(2) + "%";
          // --- پایان بخش جدید ---
        } else if (currentCoin === 'ethereum') {
          document.getElementById('coinEthereumTab').classList.add('active');
          const marketCapInMillions = (coins.ethereum.livePrice * coins.ethereum.totalSupply) / 1_000_000;
          document.getElementById("marketCap").innerText = formatMarketCap(marketCapInMillions);
        } else if (currentCoin === 'binance') {
          document.getElementById('coinBinanceTab').classList.add('active');
          const marketCapInMillions = (coins.binance.livePrice * coins.binance.totalSupply) / 1_000_000;
          document.getElementById("marketCap").innerText = formatMarketCap(marketCapInMillions);
        } else if (personalCoinKey && currentCoin === personalCoinKey) {
          document.getElementById('personalCoinTab').classList.add('active');
          const marketCapInMillions = (coins[personalCoinKey].livePrice * coins[personalCoinKey].totalSupply) / 1_000_000;
          document.getElementById("marketCap").innerText = formatMarketCap(marketCapInMillions);
        }
        // --- پایان بخش جدید ---
        // --- بخش جدید: بروزرسانی وضعیت تب ارتقاء و دکمه‌های ارتقاء پس از بارگذاری ---
        updateUpgradeTabStatus();
        updateUpgradeButtons();
        // --- پایان بخش جدید ---
      }
    }
    // ========== تابع جدید: انتقال به کیف پول ==========
    function transferToWallet() {
      const coin = getCurrentCoinData();
      const percent = parseInt(document.getElementById("tradePercent").value);
      const amountToTransfer = coin.coinAmount * (percent / 100);
      if (amountToTransfer <= 0) {
        alert("مقدار انتقال باید بیشتر از 0 باشد.");
        return;
      }
      if (coin.coinAmount < amountToTransfer) {
        alert("مقدار انتقال بیشتر از موجودی ارز در صرافی است.");
        return;
      }
      // انتقال ارز
      coin.coinAmount -= amountToTransfer;
      // افزودن یا به‌روزرسانی ارز در کیف پول
      if (!wallet[currentCoin]) {
        wallet[currentCoin] = { amount: 0, avgPrice: 0 };
      }
      // محاسبه میانگین قیمت جدید برای ارزهای کیف پول (اگر نیاز باشه)
      // در این نسخه، فقط مقدار کل انتقالی به کیف پول اضافه می‌شود
      // محاسبه میانگین قیمت جدید برای کیف پول
      const currentWalletAmount = wallet[currentCoin].amount;
      const currentWalletTotalValue = wallet[currentCoin].avgPrice * currentWalletAmount;
      const transferredValue = amountToTransfer * coin.avgPrice; // استفاده از avgPrice صرافی
      const newTotalAmount = currentWalletAmount + amountToTransfer;
      const newTotalValue = currentWalletTotalValue + transferredValue;
      wallet[currentCoin].amount = newTotalAmount;
      wallet[currentCoin].avgPrice = newTotalAmount > 0 ? newTotalValue / newTotalAmount : 0;
      // اگر تمام ارز فروخته شد، حد ضرر را نیز صفر کن
      if (coin.coinAmount <= 0) {
        coin.avgPrice = 0;
        coin.stopLossPrice = 0;
      }
      updateDisplay();
      alert(`✅ ${amountToTransfer.toFixed(4)} عدد ${coin.name} با موفقیت به کیف پول منتقل شد.`);
      saveGame();
    }
    // ========== تابع جدید: انتقال از کیف پول ==========
    function transferFromWallet() {
      const coin = getCurrentCoinData();
      const percent = parseInt(document.getElementById("tradePercent").value);
      if (!wallet[currentCoin]) {
        alert(`شما هیچ ${coin.name} در کیف پول ندارید.`);
        return;
      }
      const amountToTransfer = wallet[currentCoin].amount * (percent / 100);
      if (amountToTransfer <= 0) {
        alert("مقدار انتقال باید بیشتر از 0 باشد.");
        return;
      }
      if (wallet[currentCoin].amount < amountToTransfer) {
        alert("مقدار انتقال بیشتر از موجودی ارز در کیف پول است.");
        return;
      }
      // انتقال ارز
      wallet[currentCoin].amount -= amountToTransfer;
      // محاسبه میانگین قیمت جدید برای صرافی
      const currentCoinAmount = coin.coinAmount;
      const currentCoinTotalValue = coin.avgPrice * currentCoinAmount;
      const transferredValue = amountToTransfer * wallet[currentCoin].avgPrice; // استفاده از avgPrice کیف پول
      const newTotalAmount = currentCoinAmount + amountToTransfer;
      const newTotalValue = currentCoinTotalValue + transferredValue;
      coin.coinAmount = newTotalAmount;
      coin.avgPrice = newTotalAmount > 0 ? newTotalValue / newTotalAmount : 0;
      // اگر قبل از انتقال، صرافی خالی بود، حد ضرر جدید تنظیم کن
      if (currentCoinAmount <= 0) {
        const stopLossPercent = parseInt(document.getElementById("stopLossPercent").value);
        coin.stopLossPrice = coin.avgPrice * (1 - stopLossPercent / 100);
      }
      // اگر مقدار ارز در کیف پول صفر شد، کل کلید ارز را از کیف پول حذف کن
      if (wallet[currentCoin].amount <= 0) {
        delete wallet[currentCoin];
      }
      updateDisplay();
      alert(`✅ ${amountToTransfer.toFixed(4)} عدد ${coin.name} با موفقیت از کیف پول به صرافی منتقل شد.`);
      saveGame();
    }
    // ========== تابع جدید: نمایش محتوای کیف پول ==========
    function updateWalletDisplay() {
      const walletList = document.getElementById("walletList");
      walletList.innerHTML = ''; // پاک کردن لیست قبلی
      if (Object.keys(wallet).length === 0) {
        walletList.innerHTML = '<li style="text-align: center; color: gray;">کیف پول خالی است</li>';
        return;
      }
      for (const coinKey in wallet) {
        if (coins[coinKey]) { // اطمینان از اینکه ارز وجود دارد
          const coinInfo = coins[coinKey];
          const walletAmount = wallet[coinKey].amount;
          const walletAvgPrice = wallet[coinKey].avgPrice;
          const currentValue = walletAmount * coinInfo.livePrice;
          const pnl = (coinInfo.livePrice - walletAvgPrice) * walletAmount;
          const li = document.createElement('li');
          li.innerHTML = `
            <strong>${coinInfo.name}</strong><br>
            تعداد: ${walletAmount.toFixed(4)}<br>
            قیمت خرید میانگین: $${walletAvgPrice.toFixed(2)}<br>
            ارزش فعلی: $${currentValue.toFixed(2)}<br>
            سود/ضرر: $${pnl.toFixed(2)}
          `;
          walletList.appendChild(li);
        }
      }
    }
    // ========== تابع جدید: سوزاندن موجودی به 1000 دلار ==========
    function burnBalanceTo1000() {
      if (balance <= 1000) {
        alert("موجودی شما کمتر یا مساوی 1000 دلار است. نیازی به سوزاندن نیست.");
        return;
      }
      balance = 1000;
      updateDisplay();
      saveGame();
      alert("موجودی شما به 1000 دلار کاهش یافت! 💸🔥");
    }
    // ========== RSI Chart ==========
    const rsiCtx = document.getElementById('rsiChart').getContext('2d');
    const rsiChart = new Chart(rsiCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'RSI',
          data: [],
          borderColor: 'purple',
          borderWidth: 2,
          fill: false,
          tension: 0.1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        plugins: {
          annotation: {
            annotations: {
              line70: {
                type: 'line',
                yMin: 70,
                yMax: 70,
                borderColor: 'red',
                borderWidth: 1,
                label: { content: '70', enabled: true, position: 'start' }
              },
              line30: {
                type: 'line',
                yMin: 30,
                yMax: 30,
                borderColor: 'green',
                borderWidth: 1,
                label: { content: '30', enabled: true, position: 'start' }
              }
            }
          }
        },
        scales: {
          y: {
            min: 20,
            max: 80,
            ticks: { stepSize: 30 }
          }
        }
      }
    });
    // ========== به‌روزرسانی نمودار با همبستگی ==========
    function updateChartContent() {
      if (isPriceFrozen) return;
      // --- بخش جدید: چک کردن ماه و بروزرسانی دامیننس ---
      if (virtualMonth !== lastUpdatedMonth) {
        currentBitcoinDominance = calculateBitcoinDominance(virtualMonth);
        lastUpdatedMonth = virtualMonth;
        // اگر ارز فعلی بیتکوین است، بروزرسانی کارت اطلاعات
        if (currentCoin === 'bitcoin') {
          document.getElementById("bitcoinDominanceValue").innerText = currentBitcoinDominance.toFixed(2) + "%";
        }
        console.log(`ماه ${virtualMonth} شروع شد. دامیننس بیتکوین: ${currentBitcoinDominance}%`);
      }
      // --- پایان بخش جدید ---
      // --- محاسبه قیمت جدید بیت‌کوین (ارز پایه) ---
      const bitcoin = coins.bitcoin;
      let bias = Math.random();
      let changePercent;
      if (bias < 0.53) {
        changePercent = Math.random() * volatilityUp;
      } else {
        changePercent = -Math.random() * volatilityDown;
      }
      let newBitcoinPrice = bitcoin.livePrice * (1 + changePercent);
      newBitcoinPrice = Math.max(newBitcoinPrice, 0.1);
      let cyclicFactor = getCyclicFactor(bitcoin.cycleStep, cycleLength);
      newBitcoinPrice = newBitcoinPrice * cyclicFactor;
      bitcoin.cycleStep++;
      bitcoin.cycleStep = bitcoin.cycleStep % (cycleLength * 2);
      // --- آپدیت قیمت همه ارزها با همبستگی (تغییر درصدی بیت‌کوین + نوسان مستقل) ---
      // --- استفاده از همبستگی پویا ---
      const dynamicCorrelation = calculateCorrelationFromDominance(currentBitcoinDominance);
      const dynamicIndependentFactor = 1 - dynamicCorrelation;
      // --- پایان استفاده از همبستگی پویا ---
      for (const key in coins) {
        const coin = coins[key];
        let independentBias = Math.random();
        let independentChangePercent;
        if (independentBias < 0.5) {
          independentChangePercent = Math.random() * independentVolatility;
        } else {
          independentChangePercent = -Math.random() * independentVolatility;
        }
        // محاسبه تغییر نهایی: (تغییر بیت‌کوین * ضریب همبستگی) + (تغییر مستقل * ضریب مستقل)
        let finalChangePercent = (changePercent * dynamicCorrelation) + (independentChangePercent * dynamicIndependentFactor);
        let newPrice = coin.livePrice * (1 + finalChangePercent);
        newPrice = Math.max(newPrice, 0.1); // اطمینان از حداقل قیمت
        // اعمال تغییرات فقط برای این ارز
        applyPriceChangeForCoin(key, newPrice);
      }
      moveCounter++;
      if (moveCounter >= 30) {
        virtualDay++;
        moveCounter = 0;
        if (virtualDay > 30) {
          virtualDay = 1;
          virtualMonth++;
          if (virtualMonth > 12) {
            virtualMonth = 1;
            virtualYear++;
          }
        }
        updateCalendarDisplay(virtualDay, virtualMonth, virtualYear);
        // --- تغییر: آپدیت price24hAgo فقط برای بیت‌کوین ---
        coins.bitcoin.price24hAgo = coins.bitcoin.livePrice;
        // --- پایان تغییر ---
        const marketCapInMillions = (coins.bitcoin.livePrice * coins.bitcoin.totalSupply) / 1_000_000;
        document.getElementById("marketCap").innerText = formatMarketCap(marketCapInMillions);
      }
      // --- بخش جدید: چک کردن RSI و اعمال تغییر قیمت روی همه ارزها ---
      if (!isPriceFrozen) { // فقط اگر قیمت فریز نباشه
        for (const coinKey in coins) {
          const coin = coins[coinKey];
          const activeTfData = coin.timeframes[currentConfig.timeframe];
          const rsiLength = activeTfData.rsiData.length;
          if (rsiLength > 0) {
            // پیدا کردن آخرین مقدار RSI که null نباشه
            let lastRsiValue = null;
            for (let i = rsiLength - 1; i >= 0; i--) {
              if (activeTfData.rsiData[i] !== null) {
                lastRsiValue = parseFloat(activeTfData.rsiData[i]);
                break;
              }
            }
            if (lastRsiValue !== null) {
              let newPriceForPumpDump = coin.livePrice;
              let message = '';
              if (lastRsiValue <= 20) {
                // پامپ 2 درصدی
                newPriceForPumpDump = coin.livePrice * 1.02;
                message = `📈 RSI ${coin.name} به ${lastRsiValue.toFixed(2)} رسید! پامپ 2% اعمال شد.`;
              } else if (lastRsiValue >= 80) {
                // دامپ 2 درصدی
                newPriceForPumpDump = coin.livePrice * 0.98;
                message = `📉 RSI ${coin.name} به ${lastRsiValue.toFixed(2)} رسید! دامپ 2% اعمال شد.`;
              }
              // اگر تغییری اعمال شد (RSI در بازه مورد نظر بود)
              if (newPriceForPumpDump !== coin.livePrice) {
                // اطمینان از حداقل قیمت
                newPriceForPumpDump = Math.max(newPriceForPumpDump, 0.1);
                // اعمال تغییر قیمت روی ارز فعلی
                applyPriceChangeForCoin(coinKey, newPriceForPumpDump);
                console.log(message); // برای دیباگ، می‌تونی حذفش کنی
                // alert(message); // اگر بخوای به کاربر نشون بدی، این خط فعال کن، ولی ممکنه آزاردهنده باشه
              }
            }
          }
        }
      }
      // --- پایان بخش جدید ---
      // اگر ارز فعلی فریز نبود، نمایش و نمودار رو آپدیت کن
      // این بخش فقط اگر ارز فعلی فریز نباشه اجرا می‌شه، اما داده‌ها به روز می‌شن
      if (!isPriceFrozen) {
        updateDisplay();
        updatePriceChart();
        const activeTfData = getCurrentCoinData().timeframes[currentConfig.timeframe];
        rsiChart.data.labels = activeTfData.labels.slice(-currentConfig.maxPoints);
        rsiChart.data.datasets[0].data = activeTfData.rsiData.slice(-currentConfig.maxPoints);
        rsiChart.update();
        // آپدیت خط SMA در نمودار فعال
        const coin = getCurrentCoinData();
        const tfData = coin.timeframes[currentConfig.timeframe];
        let smaData = tfData.priceData.map((price, i) => ({
          time: Math.floor(Date.now() / 1000) - (tfData.priceData.length - i) * 60,
          value: tfData.smaData[i]
        }));
        const filteredSmaData = smaData.filter(item => item.value !== null);
        if (filteredSmaData.length > 0) {
          smaSeries.setData(filteredSmaData.slice(-currentConfig.maxPoints));
        } else {
          smaSeries.setData([]);
        }
      }
    }
    function setTimeFrame(frame) {
      if (currentIntervalId) clearInterval(currentIntervalId);
      currentConfig = timeFrameConfigs[frame];
      updatePriceChart();
      const coin = getCurrentCoinData();
      const tfData = coin.timeframes[frame];
      rsiChart.data.labels = tfData.labels.slice(-currentConfig.maxPoints);
      rsiChart.data.datasets[0].data = tfData.rsiData.slice(-currentConfig.maxPoints);
      rsiChart.update();
      currentIntervalId = setInterval(updateChartContent, currentConfig.interval);
    }
    function createMyCoin() {
      const name = document.getElementById("coinNameInput").value.trim();
      const supply = parseFloat(document.getElementById("totalSupplyInput").value);
      const price = parseFloat(document.getElementById("listingPriceInput").value);
      const network = document.getElementById("networkSelect").value; // خواندن شبکه
      if (!name || name.length < 2) {
        alert("لطفاً نام ارز را وارد کنید (حداقل 2 کاراکتر).");
        return;
      }
      if (isNaN(supply) || supply < 1000) {
        alert("تعداد کل سکه‌ها باید حداقل 1000 باشد.");
        return;
      }
      if (isNaN(price) || price <= 0) {
        alert("قیمت لیست شدن باید بیشتر از 0 باشد.");
        return;
      }
      if (balance < 100) {
        alert("موجودی شما برای ساخت ارز کافی نیست! نیاز به 100 دلار دارید.");
        return;
      }
      personalCoinKey = 'mycoin_' + Date.now();
      const myCoins = supply * 0.8; // تغییر از 0.2 به 0.8
      const freeSupply = supply - myCoins; // محاسبه سهم آزاد (20%)
      coins[personalCoinKey] = {
        name: name,
        totalSupply: supply,
        livePrice: price,
        coinAmount: myCoins, // فقط سهم سازنده
        avgPrice: price,
        stopLossPrice: price * (1 - 5/100),
        price24hAgo: price, // اضافه شد - مقدار اولیه قیمت فعلی
        cycleStep: 0,
        timeframes: {
          live: createInitialTimeframeData(price),
          hour1: createInitialTimeframeData(price),
          hour4: createInitialTimeframeData(price),
          day1: createInitialTimeframeData(price),
          week1: createInitialTimeframeData(price) // اضافه شد
        },
        upgrades: [] // شروع با لیست خالی ارتقاهای خریداری شده
      };
      balance -= 100;
      document.getElementById("personalCoinTab").innerText = name;
      document.getElementById("personalCoinTab").style.display = "inline-block";
      switchToCoin(personalCoinKey);
      const marketCapInMillions = (price * supply) / 1_000_000;
      document.getElementById("marketCap").innerText = formatMarketCap(marketCapInMillions);
      // استفاده از تابع جدید برای فرمت عرضه کل
      document.getElementById("totalSupplyDisplay").innerText = formatTotalSupply(supply);
      // بروزرسانی درصدها بعد از ساخت ارز جدید
      updateCoinPercentages();
      // --- بخش جدید: بروزرسانی وضعیت تب ارتقاء بعد از ساخت ارز ---
      updateUpgradeTabStatus();
      updateUpgradeButtons();
      // --- پایان بخش جدید ---
      alert(`🎉 ارز "${name}" بر روی شبکه "${network}" با موفقیت ساخته شد!
80% (${formatTotalSupply(myCoins)} سکه) به کیف پول شما اضافه شد.
20% (${formatTotalSupply(freeSupply)} سکه) برای فروش در بازار آزاد قرار گرفت.`);
      document.getElementById("myCoinForm").style.display = "none";
    }
    // ========== توابع صندوق نقدینگی ==========
    function depositToPool(amount) {
      if (balance < amount) {
        alert("موجودی شما برای واریز کافی نیست!");
        return;
      }
      balance -= amount;
      liquidityPool += amount;
      updateDisplay();
      updateCoinPercentages();
      saveGame();
    }
    function withdrawFromPool(amount) {
      if (liquidityPool < amount) {
        alert("موجودی صندوق برای برداشت کافی نیست!");
        return;
      }
      balance += amount;
      liquidityPool -= amount;
      updateDisplay();
      updateCoinPercentages();
      saveGame();
    }
    // ========== توابع مربوط به ارتقاء ==========
    // --- تابع جدید: بروزرسانی وضعیت تب ارتقاء ---
    function updateUpgradeTabStatus() {
      const upgradeTab = document.getElementById('upgradeTab');
      // حذف event listener قبلی، صرف نظر از اینکه فعال بوده یا نه
      upgradeTab.onclick = null;

      if (currentCoin === personalCoinKey) {
        upgradeTab.classList.remove('upgrade-tab-inactive');
        upgradeTab.style.opacity = '1';
        upgradeTab.style.cursor = 'pointer';
        // اضافه کردن event listener فقط اگر ارز شخصی باشد
        upgradeTab.onclick = showUpgradeCard;
      } else {
        upgradeTab.classList.add('upgrade-tab-inactive');
        upgradeTab.style.opacity = '0.5';
        upgradeTab.style.cursor = 'not-allowed';
        // تأیید که event listener حذف شده است
      }
    }
    // --- تابع جدید: نمایش کارت ارتقاء ---
    function showUpgradeCard() {
      const upgradeCard = document.getElementById('upgradeCard');
      if (upgradeCard.style.display === 'none') {
        upgradeCard.style.display = 'block';
        showOverlay();
      } else {
        upgradeCard.style.display = 'none';
        hideOverlay();
      }
    }
    // --- تابع جدید: بروزرسانی وضعیت دکمه‌های ارتقاء ---
    function updateUpgradeButtons() {
      if (currentCoin !== personalCoinKey) return; // فقط اگر ارز شخصی انتخاب شده باشد

      const coin = getCurrentCoinData();
      const upgrades = coin.upgrades || []; // اگر ارتقاهایی وجود نداشت، لیست خالی

      const upgradeButtons = {
        'upgradeTpsBtn': 'TPS',
        'upgradeSecurityBtn': 'Security',
        'upgradeConsensusBtn': 'Consensus',
        'upgradeNftBtn': 'NFT',
        'upgradeMarketingBtn': 'Marketing'
      };

      for (const [buttonId, upgradeName] of Object.entries(upgradeButtons)) {
        const button = document.getElementById(buttonId);
        if (button) {
          if (upgrades.includes(upgradeName)) {
            // ارتقاء قبلاً خریداری شده
            button.disabled = true;
            button.textContent = '✅';
          } else {
            // ارتقاء در دسترس برای خرید
            button.disabled = false;
            button.textContent = 'خرید';
          }
        }
      }
    }
    // --- تابع جدید: خرید ارتقاء ---
    function purchaseUpgrade(upgradeName) {
      if (currentCoin !== personalCoinKey) {
        alert("ابتدا ارز شخصی خود را انتخاب کنید.");
        return;
      }
      if (balance < 1000) {
        alert("موجودی شما برای خرید این ارتقاء کافی نیست! نیاز به 1000 دلار دارید.");
        return;
      }

      const coin = getCurrentCoinData();
      if (!coin.upgrades) {
        coin.upgrades = [];
      }

      if (coin.upgrades.includes(upgradeName)) {
        alert("این ارتقاء قبلاً خریداری شده است.");
        return;
      }

      balance -= 1000;
      coin.upgrades.push(upgradeName); // اضافه کردن ارتقاء به لیست

      // پامپ 5% قیمت
      coin.livePrice *= 1.05;
      // اعمال تغییر قیمت به تمام تایم‌فریم‌ها
      for (let tf of ['live', 'hour1', 'hour4', 'day1', 'week1']) {
        const data = coin.timeframes[tf];
        if (data.priceData.length > 0) {
          data.priceData[data.priceData.length - 1] = coin.livePrice;
          data.rsiData = calculateRSI(data.priceData, rsiPeriod);
          data.smaData = calculateSMA(data.priceData, smaPeriod);
        }
      }
      // آپدیت نمودارها و نمایش
      updateDisplay();
      updatePriceChart();
      const activeTfData = coin.timeframes[currentConfig.timeframe];
      rsiChart.data.labels = activeTfData.labels.slice(-currentConfig.maxPoints);
      rsiChart.data.datasets[0].data = activeTfData.rsiData.slice(-currentConfig.maxPoints);
      rsiChart.update();

      alert(`🎉 ارتقاء "${upgradeName}" با موفقیت خریداری شد! قیمت ارز شما 5% پامپ شد.`);
      saveGame();
    }
    // ========== رویدادها ==========
    document.querySelectorAll('.timeframe-tab').forEach(tab => {
      tab.addEventListener('click', function() {
        const frame = this.getAttribute('data-frame');
        if (!frame) return;
        // اول تایم فریم رو تغییر بده
        setTimeFrame(frame);
        // بعد کلاس active رو بروزرسانی کن
        document.querySelectorAll('.timeframe-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
      });
    });
    // اضافه کردن رویداد کلیک برای تب‌های ارزهای جدید
    document.getElementById('coinNameTab').addEventListener('click', () => {
      switchToCoin('bitcoin');
    });
    document.getElementById('coinEthereumTab').addEventListener('click', () => {
      switchToCoin('ethereum');
    });
    document.getElementById('coinBinanceTab').addEventListener('click', () => {
      switchToCoin('binance');
    });
    document.getElementById('personalCoinTab').addEventListener('click', () => {
      if (personalCoinKey && coins[personalCoinKey]) {
        switchToCoin(personalCoinKey);
      }
    });
    document.getElementById('secretTab').addEventListener('click', function() {
      const form = document.getElementById('secretForm');
      form.style.display = (form.style.display === 'none') ? 'block' : 'none';
    });
    document.getElementById('orderType').addEventListener('change', function() {
      const limitInput = document.getElementById('limitPriceInput');
      if (this.value === 'limit') {
        limitInput.style.display = 'block';
      } else {
        limitInput.style.display = 'none';
      }
    });
    document.getElementById("buyBtn").addEventListener("click", function() {
      const coin = getCurrentCoinData();
      const orderType = document.getElementById("orderType").value;
      const percent = parseInt(document.getElementById("tradePercent").value);
      const amountToSpend = balance * (percent / 100);
      if (orderType === 'market') {
        // --- بخش اصلاح شده: چک کردن محدودیت کل سکه‌های خریداری شده (صفاری + کیف پول) قبل از خرید ---
        const totalBoughtByUser = coin.coinAmount + (wallet[currentCoin]?.amount || 0);
        if (balance <= 0 || totalBoughtByUser >= coin.totalSupply) {
          if (totalBoughtByUser >= coin.totalSupply) {
            alert("❌ تمام سکه‌ها توسط شما (در صرافی یا کیف پول) خریداری شده‌اند! دیگر امکان خرید وجود ندارد.");
          }
          return; // خارج شو اگر شرایط برقرار بود
        }
        // --- پایان بخش اصلاح شده ---
        const coinsBought = amountToSpend / coin.livePrice;
        // اینجا باید محدودیت جدید رو بررسی کنیم: آیا مجموع سکه‌های جدید + سکه‌های موجود (صفاری + کیف پول) بیشتر از کل عرضه نمیشه؟
        const maxCoinsAllowedBySupply = coin.totalSupply - (coin.coinAmount + (wallet[currentCoin]?.amount || 0)); // مقداری که می‌تونیم حداکثر بخریم
        if (coinsBought > maxCoinsAllowedBySupply) {
          if (maxCoinsAllowedBySupply <= 0) {
            // این باید از چک اول گذشته باشه، اما اگر اتفاقی اینجا رسید، هنوز 0 یا کمتر مجازه
            alert("❌ تمام سکه‌ها توسط شما (در صرافی یا کیف پول) خریداری شده‌اند! دیگر امکان خرید وجود ندارد.");
            return;
          }
          // فقط مقدار مجاز خریداری شود
          const newAmount = maxCoinsAllowedBySupply * coin.livePrice;
          balance -= newAmount;
          coin.coinAmount += maxCoinsAllowedBySupply;
          coin.avgPrice = coin.coinAmount > 0
            ? ((coin.avgPrice * (coin.coinAmount - maxCoinsAllowedBySupply)) + (coin.livePrice * maxCoinsAllowedBySupply)) / coin.coinAmount
            : coin.livePrice;
          alert(`⚠️ فقط ${maxCoinsAllowedBySupply.toFixed(4)} سکه دیگر می‌توانید بخرید (با توجه به سکه‌های موجود در کیف پول). خرید به این مقدار محدود شد.`);
        } else {
          // خرید معمولی
          balance -= amountToSpend;
          coin.coinAmount += coinsBought;
          coin.avgPrice = coin.coinAmount > 0
            ? ((coin.avgPrice * (coin.coinAmount - coinsBought)) + (coin.livePrice * coinsBought)) / coin.coinAmount
            : coin.livePrice;
        }
        const stopLossPercent = parseInt(document.getElementById("stopLossPercent").value);
        coin.stopLossPrice = coin.avgPrice * (1 - stopLossPercent / 100);
        const onePercentSupply = coin.totalSupply * 0.01;
        if (!isPriceFrozen && coinsBought >= onePercentSupply) {
          const newPrice = coin.livePrice * 1.05;
          applyPriceChangeForCoin(currentCoin, newPrice);
          if (currentCoin === 'bitcoin') {
             coins.bitcoin.livePrice = newPrice;
          }
          alert(`🔥 پامپ! خرید بزرگ (${(coinsBought / coin.totalSupply * 100).toFixed(2)}%) باعث رشد 5% قیمت شد!`);
        } else {
          updateDisplay();
          // updateCoinPercentages(); // اینجا نیاز نیست چون updateDisplay این کار را می‌کند
        }
      } else if (orderType === 'limit') {
        const limitPrice = parseFloat(document.getElementById("limitPrice").value);
        if (isNaN(limitPrice) || limitPrice <= 0) {
          alert("لطفاً قیمت لیمیت معتبر وارد کنید.");
          return;
        }
        limitOrders.push({
          type: 'buy',
          price: limitPrice,
          amount: amountToSpend,
          coinKey: currentCoin
        });
        alert(`✅ اوردر خرید لیمیت به قیمت $${limitPrice} ثبت شد.`);
      }
      saveGame();
    });
    document.getElementById("sellBtn").addEventListener("click", function() {
      const coin = getCurrentCoinData();
      const orderType = document.getElementById("orderType").value;
      const percent = parseInt(document.getElementById("tradePercent").value);
      const coinsToSell = coin.coinAmount * (percent / 100);
      if (orderType === 'market') {
        if (coin.coinAmount <= 0) return;
        const onePercentSupply = coin.totalSupply * 0.01;
        if (!isPriceFrozen && coinsToSell >= onePercentSupply) {
          balance += coinsToSell * coin.livePrice;
          coin.coinAmount -= coinsToSell;
          if (coin.coinAmount <= 0) {
            coin.coinAmount = 0;
            coin.avgPrice = 0;
          }
          const newPrice = coin.livePrice * 0.95;
          applyPriceChangeForCoin(currentCoin, newPrice);
          if (currentCoin === 'bitcoin') {
             coins.bitcoin.livePrice = newPrice;
          }
          alert(`📉 دامپ! فروش بزرگ (${(coinsToSell / coin.totalSupply * 100).toFixed(2)}%) باعث سقوط 5% قیمت شد!`);
        } else {
          balance += coinsToSell * coin.livePrice;
          coin.coinAmount -= coinsToSell;
          if (coin.coinAmount <= 0) {
            coin.coinAmount = 0;
            coin.avgPrice = 0;
          }
          updateDisplay();
          // updateCoinPercentages(); // اینجا نیاز نیست چون updateDisplay این کار را می‌کند
        }
      } else if (orderType === 'limit') {
        const limitPrice = parseFloat(document.getElementById("limitPrice").value);
        if (isNaN(limitPrice) || limitPrice <= 0) {
          alert("لطفاً قیمت لیمیت معتبر وارد کنید.");
          return;
        }
        const amountToSell = coinsToSell * coin.livePrice;
        limitOrders.push({
          type: 'sell',
          price: limitPrice,
          amount: amountToSell,
          coinKey: currentCoin
        });
        alert(`✅ اوردر فروش لیمیت به قیمت $${limitPrice} ثبت شد.`);
      }
      saveGame();
    });
    document.getElementById('applySecret').addEventListener('click', function() {
      const code = document.getElementById('secretCode').value.trim();
      const amount = parseFloat(document.getElementById('secretAmount').value);
      if (code.toLowerCase() === 'مهران' && !isNaN(amount) && amount > 0) {
        balance += amount;
        updateDisplay();
        alert(`تبریک! ${amount} دلار به موجودیت اضافه شد 💰`);
        document.getElementById('secretCode').value = '';
        document.getElementById('secretAmount').value = '';
        document.getElementById('secretForm').style.display = 'none';
      } else {
        alert('کد یا مقدار وارد شده اشتباهه 😕');
      }
    });
    document.getElementById("resetBtn").addEventListener("click", () => {
      if (confirm("آیا مطمئن هستید که می‌خواهید بازی را ریست کنید؟ این عمل قابل بازگشت نیست.")) {
        localStorage.removeItem("nasrTradingGameSave");
        balance = 1000;
        virtualDay = 1;
        virtualMonth = 1;
        virtualYear = 2022;
        moveCounter = 0;
        isPriceFrozen = false;
        liquidityPool = 100000;
        traderName = "پلیر";
        initialBalance = 1000;
        limitOrders = [];
        // --- ریست متغیرهای جدید ---
        currentBitcoinDominance = 40; // شروع با 40%
        lastUpdatedMonth = virtualMonth; // ذخیره آخرین ماه بروزرسانی
        // --- پایان ریست ---
        coins = {
          bitcoin: {
            name: "بیتکوین",
            totalSupply: 21000000,
            livePrice: 16000, // تغییر کرد
            coinAmount: 0,
            avgPrice: 0,
            stopLossPrice: 0,
            price24hAgo: 16000, // اضافه شد
            cycleStep: 0,
            timeframes: {
              live: createInitialTimeframeData(16000), // تغییر کرد
              hour1: createInitialTimeframeData(16000), // تغییر کرد
              hour4: createInitialTimeframeData(16000), // تغییر کرد
              day1: createInitialTimeframeData(16000), // تغییر کرد
              week1: createInitialTimeframeData(16000) // تغییر کرد
            }
          },
          // اضافه کردن دوباره اتریوم و بایننس کوین در ریست با قیمت جدید و price24hAgo
          ethereum: {
            name: "اتریوم",
            totalSupply: 120000000, // 120M
            livePrice: 1100, // تغییر کرد
            coinAmount: 0,
            avgPrice: 0,
            stopLossPrice: 0,
            price24hAgo: 1100, // اضافه شد
            cycleStep: 0,
            timeframes: {
              live: createInitialTimeframeData(1100), // تغییر کرد
              hour1: createInitialTimeframeData(1100), // تغییر کرد
              hour4: createInitialTimeframeData(1100), // تغییر کرد
              day1: createInitialTimeframeData(1100), // تغییر کرد
              week1: createInitialTimeframeData(1100) // تغییر کرد
            }
          },
          binance: {
            name: "بایننس کوین",
            totalSupply: 140000000, // 140M
            livePrice: 200, // تغییر کرد
            coinAmount: 0,
            avgPrice: 0,
            stopLossPrice: 0,
            price24hAgo: 200, // اضافه شد
            cycleStep: 0,
            timeframes: {
              live: createInitialTimeframeData(200), // تغییر کرد
              hour1: createInitialTimeframeData(200), // تغییر کرد
              hour4: createInitialTimeframeData(200), // تغییر کرد
              day1: createInitialTimeframeData(200), // تغییر کرد
              week1: createInitialTimeframeData(200) // تغییر کرد
            }
          }
        };
        currentCoin = 'bitcoin';
        personalCoinKey = null;
        wallet = {}; // ریست کردن کیف پول
        updateCoinPercentages();
        updateDisplay();
        updateCalendarDisplay(virtualDay, virtualMonth, virtualYear);
        document.getElementById("coinNameDisplay").innerText = "بیتکوین";
        // --- نمایش دامیننس در کارت اطلاعات بیتکوین بعد از ریست ---
        document.getElementById("dominanceDisplay").style.display = 'block';
        document.getElementById("bitcoinDominanceValue").innerText = currentBitcoinDominance.toFixed(2) + "%";
        // --- پایان بخش جدید ---
        // استفاده از تابع جدید برای فرمت عرضه کل
        document.getElementById("totalSupplyDisplay").innerText = formatTotalSupply(21000000);
        document.getElementById("coinNameTab").innerText = "بیتکوین";
        document.getElementById("coinEthereumTab").innerText = "اتریوم";
        document.getElementById("coinBinanceTab").innerText = "بایننس کوین";
        document.getElementById("personalCoinTab").style.display = "none";
        const initialMarketCapInMillions = (16000 * 21000000) / 1_000_000; // تغییر کرد
        document.getElementById("marketCap").innerText = formatMarketCap(initialMarketCapInMillions);
        updatePriceChart();
        rsiChart.data.labels = [1];
        rsiChart.data.datasets[0].data = coins.bitcoin.timeframes.live.rsiData;
        rsiChart.update();
        document.getElementById('freezePriceBtn').innerText = '⏸️';
        document.getElementById('freezePriceBtn').title = 'فریز قیمت (جلوگیری از پامپ/دامپ)';
        // بروزرسانی کلاس‌های فعال بعد از ریست
        document.querySelectorAll('.coin-tab').forEach(tab => tab.classList.remove('active'));
        document.getElementById('coinNameTab').classList.add('active');
        // --- بخش جدید: بروزرسانی وضعیت تب ارتقاء و دکمه‌های ارتقاء پس از ریست ---
        updateUpgradeTabStatus();
        updateUpgradeButtons();
        // --- پایان بخش جدید ---
        alert("بازی با موفقیت ریست شد.");
      }
    });
    // اضافه کردن رویداد کلیک برای دکمه جدید سوزاندن
    document.getElementById('burnBalanceBtn').addEventListener('click', burnBalanceTo1000);
    // Overlay برای کارت‌ها
    function showOverlay() {
      if (!document.getElementById('overlay')) {
        const overlay = document.createElement('div');
        overlay.id = 'overlay';
        document.body.appendChild(overlay);
        document.body.style.overflow = 'hidden';
      }
    }
    function hideOverlay() {
      const overlay = document.getElementById('overlay');
      if (overlay) {
        overlay.remove();
        document.body.style.overflow = '';
      }
    }
    document.getElementById('infoTab').addEventListener('click', () => {
      const infoCard = document.getElementById('infoCard');
      if (infoCard.style.display === 'none') {
        infoCard.style.display = 'block';
        showOverlay();
      } else {
        infoCard.style.display = 'none';
        hideOverlay();
      }
    });
    document.getElementById('infoCard').addEventListener('click', () => {
      document.getElementById('infoCard').style.display = 'none';
      hideOverlay();
    });
    document.getElementById('myCoinTab').addEventListener('click', () => {
      const form = document.getElementById('myCoinForm');
      if (form.style.display === 'none') {
        form.style.display = 'block';
        showOverlay();
      } else {
        form.style.display = 'none';
        hideOverlay();
      }
    });
    document.getElementById('closeMyCoinForm').addEventListener('click', () => {
      document.getElementById('myCoinForm').style.display = 'none';
        hideOverlay();
    });
    // تب پروفایل
    document.getElementById('profileTab').addEventListener('click', () => {
      const profileCard = document.getElementById('profileCard');
      if (profileCard.style.display === 'none') {
        profileCard.style.display = 'block';
        showOverlay();
      } else {
        profileCard.style.display = 'none';
        hideOverlay();
      }
    });
    document.getElementById('profileCard').addEventListener('click', () => {
      document.getElementById('profileCard').style.display = 'none';
      hideOverlay();
    });
    // تب کیف پول
    document.getElementById('walletTab').addEventListener('click', () => {
      const walletCard = document.getElementById('walletCard');
      if (walletCard.style.display === 'none') {
        walletCard.style.display = 'block';
        showOverlay();
        updateWalletDisplay(); // نمایش محتوای کیف پول هنگام باز شدن
      } else {
        walletCard.style.display = 'none';
        hideOverlay();
      }
    });
    document.getElementById('walletCard').addEventListener('click', () => {
      document.getElementById('walletCard').style.display = 'none';
      hideOverlay();
    });
    // تب ارتقاء (Diamond) - دیگر onclick مستقیم ندارد
    // document.getElementById('upgradeTab').addEventListener('click', showUpgradeCard); // این خط حذف شد
    document.getElementById('upgradeCard').addEventListener('click', () => {
      document.getElementById('upgradeCard').style.display = 'none';
      hideOverlay();
    });
    // دکمه‌های خرید ارتقاء
    document.getElementById('upgradeTpsBtn').addEventListener('click', () => purchaseUpgrade('TPS'));
    document.getElementById('upgradeSecurityBtn').addEventListener('click', () => purchaseUpgrade('Security'));
    document.getElementById('upgradeConsensusBtn').addEventListener('click', () => purchaseUpgrade('Consensus'));
    document.getElementById('upgradeNftBtn').addEventListener('click', () => purchaseUpgrade('NFT'));
    document.getElementById('upgradeMarketingBtn').addEventListener('click', () => purchaseUpgrade('Marketing'));

    document.addEventListener('click', (e) => {
      if (e.target.id === 'overlay') {
        hideOverlay();
        document.getElementById('infoCard').style.display = 'none';
        document.getElementById('myCoinForm').style.display = 'none';
        document.getElementById('secretForm').style.display = 'none';
        document.getElementById('profileCard').style.display = 'none';
        document.getElementById('walletCard').style.display = 'none';
        document.getElementById('upgradeCard').style.display = 'none'; // اضافه شد
      }
    });
    document.getElementById('freezePriceBtn').addEventListener('click', function() {
      isPriceFrozen = !isPriceFrozen;
      this.innerText = isPriceFrozen ? '▶️' : '⏸️';
      this.title = isPriceFrozen ? 'قیمت فریز شده — پامپ/دامپ غیرفعال' : 'فریز قیمت (جلوگیری از پامپ/دامپ)';
      saveGame();
    });
    document.getElementById('createCoinBtn').addEventListener('click', createMyCoin);
    // رویدادهای جدید برای دکمه‌های انتقال
    document.getElementById('transferToWalletBtn').addEventListener('click', transferToWallet);
    document.getElementById('transferFromWalletBtn').addEventListener('click', transferFromWallet);
    window.onload = () => {
      loadGame();
      initPriceChart();
      const coin = getCurrentCoinData();
      updateDisplay();
      updateCalendarDisplay(virtualDay, virtualMonth, virtualYear);
      updateCoinPercentages();
      document.getElementById("coinNameDisplay").innerText = coin.name;
      // --- نمایش دامیننس در کارت اطلاعات بیتکوین بعد از بارگذاری ---
      if (currentCoin === 'bitcoin') {
          document.getElementById("dominanceDisplay").style.display = 'block';
          document.getElementById("bitcoinDominanceValue").innerText = currentBitcoinDominance.toFixed(2) + "%";
      } else {
          document.getElementById("dominanceDisplay").style.display = 'none';
      }
      // --- پایان بخش جدید ---
      // استفاده از تابع جدید برای فرمت عرضه کل
      document.getElementById("totalSupplyDisplay").innerText = formatTotalSupply(coin.totalSupply);
      document.getElementById("coinNameTab").innerText = "بیتکوین";
      document.getElementById("coinEthereumTab").innerText = "اتریوم";
      document.getElementById("coinBinanceTab").innerText = "بایننس کوین";
      document.getElementById("traderName").innerText = traderName;
      const initialMarketCapInMillions = (coin.livePrice * coin.totalSupply) / 1_000_000;
      document.getElementById("marketCap").innerText = formatMarketCap(initialMarketCapInMillions);
      setTimeFrame("live");
    };
  </script>
</body>
</html>
